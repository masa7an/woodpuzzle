# Wood Puzzle - ロードマップ

## プロジェクト概要

**ジャンル**: はめ込み型シルエットパズル  
**技術**: Python + Pygame  
**目標**: 不定形の枠にピースをはめて完成させるパズルゲーム

---

## 技術仕様

| 項目 | 仕様 |
|------|------|
| 言語 | Python 3.x |
| ライブラリ | Pygame |
| 内部表現 | 2Dグリッド（1=有効セル, 0=無効セル） |
| 座標系 | 整数セル座標 |
| 判定 | セル一致100%でスナップ |

---

## フェーズ 1: 基盤構築（MVP）

**目標**: Stage 1（赤十字型）が遊べる最小限の実装

### 1-1. プロジェクト構造
- [x] ディレクトリ構成作成
- [x] Pygame初期化・ウィンドウ表示

### 1-2. グリッドシステム
- [x] グリッド定義（2D配列）
- [x] 枠の描画（赤十字型）

### 1-3. ピースシステム
- [x] ピースデータ構造（セル座標リスト）
- [x] ピース描画

### 1-4. ドラッグ＆ドロップ
- [x] マウスでピースを掴む
- [x] ピースを移動
- [x] 離したときにグリッドにスナップ

### 1-5. 配置判定
- [x] 枠内かどうか判定
- [x] 他ピースと重複しないか判定
- [x] 無効な配置は元に戻す

### 1-6. クリア判定
- [x] 全セルが埋まったか判定
- [x] クリア演出（シンプル）

---

## フェーズ 2: Stage 1 完成

**目標**: 良い難易度のStage 1を完成

### 2-1. ピースデザイン（正解から逆算）
- [x] 正解配置を設計
- [x] 正解からピースを分割
- [x] 正解表示機能（Sキー）を追加

### 2-2. ステージエディタ
- [x] エディタモード切り替え（Eキー）
- [x] セルクリックでピースID変更
- [x] 設計結果をコンソール出力（Pキー）

### 2-3. ビジュアル改善
- [x] ピースごとに異なる色
- [x] 枠の視覚的区別
- [x] 配置可能セルのハイライト（ヒント機能）

---

## フェーズ 3: UX改善

**目標**: 快適に遊べるようにする

### 3-1. 操作性
- [x] アンドゥ機能（ピースを外す）
- [x] ピース選択時の視覚フィードバック ✅
  - ドラッグ中は色を明るく、白い太い枠線で強調表示

### 3-2. ヒント機能
- [x] 配置可能領域ハイライト（ドラッグ中に自動表示）
- [x] ゴースト表示（Hキーで正解位置を半透明で表示）

### 3-3. ステージ遷移
- [x] クリア後にNEXTステージへ遷移（オールクリア時は終了/リトライ）

### 3-4. 演出
- [ ] クリア演出の強化
- [x] 配置済みピースの色変更
- [x] 効果音

### 3-5. データ外部化
- [x] ステージ定義を.stageファイルに分離
- [x] ピース定義を.stageファイルに分離

### 3-6. タイムアタック機能
- [x] RTAタイム表示（Tキーで表示/非表示切替、24時間対応）
- [x] タイムランキング（1st, 2nd... TIME）

---

## フェーズ 4: Web展開 & 分析

**目標**: ブラウザ上でプレイ可能にし、ユーザー行動を分析する

### 4-1. Web移植
- [x] Pygbag等によるWASMビルド（WebAssembly）
- [x] 非同期ループ対応（asyncio）
- [x] Web版ランキング保存（localStorage）

### 4-2. 分析・計測
- [x] Google Analytics 4 (GA4) の実装
- [x] PV（ページビュー）の計測
- [x] イベントトラッキング（クリア率など）
- [x] プライバシーポリシー（ゲーム内ポップアップ）

### 4-3. GitHub Pagesデプロイ
- [x] ビルドフォルダ準備（build/web）
- [x] README.md 作成
- [x] .nojekyll 作成（Jekyll無効化）
- [x] privacy.html 配置
- [x] リポジトリ作成 & プッシュ
- [x] GitHub Pages 有効化（Settings → Pages）
- [x] 動作確認 ✅ https://masa7an.github.io/woodpuzzle/

---

## フェーズ 5: 日本語化（ローカライズ）

**目標**: UIおよびメッセージを日本語に対応させる

### 5-1. テキストリソースの分離
- [x] テキストの定数化・外部ファイル化（JSON等）
- [x] 言語切り替え機能の実装（英語/日本語）

### 5-2. UI翻訳
- [x] タイトル画面・メニューの日本語化
- [x] チュートリアル・操作説明の日本語化
- [x] クリアメッセージ・ランキング表示の調整

---

## フェーズ 6: Web版デバッグ（フリーズ対策）

**目標**: Web版でのクリア時フリーズ問題を解決する

### 6-1. パフォーマンス最適化
- [x] フォントレンダリングの最適化（キャッシュ化）
- [x] タイマー描画の効率化（10ms制御、SysFont初期化分離）
- [x] ファイルI/Oの排除（Web向け）
- [x] 操作説明描画の最適化（キャッシュ化）

### 6-2. エラー切り分け（完了）
以下の機能を一時無効化して原因を特定した：
- [x] SPACEキー処理の無効化 → フリーズ継続（無実）
- [x] クリア画面描画の無効化 → フリーズ継続（無実）
- [x] Analytics (GA4) の無効化 → **フリーズ解消（原因特定）**

### 6-3. 原因と対策
**原因**: `window.eval()` によるJavaScript実行がPygbag環境でブロッキング動作となり、ゲームループがフリーズしていた。`setTimeout`でのラップも効果なし。

**対策（案A採用）**:
- Python側: Web版ではAnalytics機能を完全無効化（`analytics.py`）
- HTML側: `scripts/inject_ga4.py` でビルド後に `index.html` へGA4タグを注入
- PV計測は自動で行われる（イベント送信は行わない）

---

## フェーズ 7: スマホ操作対応

**目標**: タッチ操作に最適化し、スマートフォンでの快適なプレイを実現する

### 7-1. タッチ操作
- [x] 操作説明メニューのタップ対応（Z/T/R/S/H/L/P）
- [x] Web版のみタップ有効（PCクリックは従来通り）
- [-] ピンチ操作対応（実装しない）

### 7-2. UI調整
- [x] 操作説明の行間を広げる（22px → 35px）
- [-] ボタンサイズの最適化（タップ領域で対応済み）

### 7-3. 動作確認
- [ ] iOS Safari での動作確認
- [ ] Android Chrome での動作確認

---

## フェーズ 8: パフォーマンス最適化（もっさり感改善）✅ 完了

**目標**: Web版のレスポンスを改善し、スムーズな操作感を実現する

**完了日**: 2024年（最適化作業完了）

### 8-1. 非同期処理の最適化
- [x] `await asyncio.sleep(0)` の適切な配置確認（ループ最後に1回のみ）✅
- [x] 時間指定の `asyncio.sleep()` を排除 ✅
- [x] フレーム内の重い処理を特定・軽量化 ✅
  - `clock.tick(60)` を削除
  - `_draw_placeable_highlight()` の最適化（候補セル絞り込み）
  - `pygame.Rect` の毎フレーム生成を削減

### 8-2. オブジェクト生成の最適化
- [x] `pygame.Rect` の毎フレーム生成を排除（キャッシュ化）✅
  - `grid.py`, `piece.py`, `game.py` の描画メソッドで削減
- [x] フォント読み込みの最適化（既存キャッシュの見直し）✅
  - `_draw_privacy_policy()` のキャッシュ化
  - `_draw_title_screen()` のキャッシュ化
  - `_draw_save_message()` のキャッシュ化
- [x] リスト内包表記の毎フレーム実行を排除 ✅
  - 確認済み（初期化時のみ、問題なし）

### 8-3. 描画処理の最適化
- [x] 不要な再描画の排除 ✅
  - グリッド描画を最適化（有効セルのみ描画、`valid_cells`リストを使用）
- [x] 描画範囲の最適化（ダーティ矩形等）✅
  - グリッド描画で無効セルの描画をスキップ
  - `screen.fill()`は背景クリアに必要（最適化不要）
- [x] タイマー表示の間引き確認 ✅
  - 既に10ms間隔で実装済み（`_timer_update_interval = 0.01`）

### 8-4. メモリ管理
- [x] タスク未回収の確認（`asyncio.create_task()` の適切な管理）✅
  - `asyncio.create_task()`は使用されていない（問題なし）
- [x] メモリリークの検証 ✅
  - ステージロード時に全キャッシュをクリアするように改善
  - `action_history`は適切にクリアされている
  - `ranking`は最大5件に制限されている
  - キャッシュは適切に管理されている

### 8-5. その他の最適化課題（発見事項）
- [x] `_draw_ghost()` の半透明描画の確認（RGBA対応の確認）✅
  - Surfaceを使用した半透明描画に修正
- [x] `grid.release()` のリスト内包表記の最適化（優先度：低、配置解除時のみ）✅
  - リスト内包表記を通常のループに変更
- [ ] エディタモードの描画最適化（通常プレイ時は使用されないため優先度：低）

---

## 将来フェーズ（スコープ外）

### 回転機能
- [ ] 90度回転操作（ボタン or 右クリック）
- [ ] 回転後のスナップ判定

### ステージ追加
- [x] Stage 2〜10 実装
- [ ] Stage 11〜20 図柄追加（候補）
  - Stage 11: Apple (りんご)
  - Stage 12: Mushroom (きのこ)
  - Stage 13: Umbrella (傘)
  - Stage 14: Star (星)
  - Stage 15: Dog (犬)
  - Stage 16: Cat (猫)
  - Stage 17: Flower (花)
  - Stage 18: Car (車)
  - Stage 19: Robot (ロボット)
  - Stage 20: Crown (王冠)

### 反転機能（メモ）
> 反転（ミラー）はゲーム難易度を大きく上げるため、当面スコープ外。  
> 将来的に上級ステージで検討する可能性あり。

---

## ディレクトリ構成（予定）

```
woodpazzule/
├── ROADMAP.md
├── main.py          # エントリーポイント
├── src/
│   ├── game.py      # ゲームループ
│   ├── grid.py      # グリッド管理
│   ├── piece.py     # ピースクラス
│   └── ui.py        # UI描画
├── stages/
│   └── stage1.json  # ステージ定義
└── assets/
    └── (画像・音声等)
```

---

## 注意事項

1. **物理演算不要** - 整数座標のみで判定
2. **浮動小数不使用** - セル座標ベース
3. **シンプル優先** - 機能追加は段階的に
4. **手動テスト必須** - 自分で1回解いて難易度確認
5. **UI操作表示** - 左メニューのキー操作は必ず一行に1キーまで（視認性向上）

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2024-12-14 | 初版作成 |
| 2025-12-19 | フェーズ8完了: パフォーマンス最適化（もっさり感改善）<br>- 非同期処理の最適化（`clock.tick()`削除、重い処理の軽量化）<br>- オブジェクト生成の最適化（`pygame.Rect`削減、フォントキャッシュ化）<br>- 描画処理の最適化（グリッド描画の効率化、有効セルのみ描画）<br>- メモリ管理の改善（キャッシュクリア、メモリリーク対策）<br>- フェーズ3-1完了: ピース選択時の視覚フィードバック追加<br>- コードの重複削除とリファクタリング |
